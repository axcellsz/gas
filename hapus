#!/usr/bin/env bash
set -euo pipefail

DOMAIN="sgdo1.vhipee.tech"

echo "[1/7] Stop services..."
systemctl stop xray 2>/dev/null || true
systemctl stop nginx 2>/dev/null || true

echo "[2/7] Disable services..."
systemctl disable xray 2>/dev/null || true
systemctl disable nginx 2>/dev/null || true

echo "[3/7] Remove Xray..."
# stop binary if still exists
pkill -f xray 2>/dev/null || true

rm -f /usr/local/bin/xray
rm -rf /usr/local/etc/xray
rm -rf /etc/xray
rm -rf /var/log/xray

rm -f /etc/systemd/system/xray.service
rm -rf /etc/systemd/system/xray.service.d

systemctl daemon-reload
systemctl reset-failed

echo "[4/7] Remove Nginx configs..."
rm -f /etc/nginx/sites-enabled/*
rm -f /etc/nginx/sites-available/*
rm -f /etc/nginx/conf.d/*
rm -rf /var/www/html

echo "[5/7] Remove Let's Encrypt / Certbot..."
certbot delete --cert-name "${DOMAIN}" --non-interactive 2>/dev/null || true

rm -rf /etc/letsencrypt
rm -rf /var/lib/letsencrypt
rm -rf /var/log/letsencrypt

echo "[6/7] Purge packages..."
apt-get purge -y \
  nginx nginx-common nginx-core \
  certbot python3-certbot-nginx \
  socat cron net-tools || true

apt-get autoremove -y
apt-get autoclean -y

echo "[7/7] Final cleanup..."
rm -rf /root/.acme.sh
rm -f /etc/cron.d/*xray*
rm -f /etc/cron.daily/*certbot*
rm -f /etc/cron.weekly/*certbot*
rm -f /etc/cron.monthly/*certbot*

echo
echo "===== UNINSTALL COMPLETE ====="
echo "✔ Xray removed"
echo "✔ Nginx removed"
echo "✔ SSL / Certbot removed"
echo "✔ Config & logs wiped"
echo
echo "System is CLEAN."
echo "Reboot recommended."
