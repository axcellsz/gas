#!/usr/bin/env bash
set -euo pipefail

# ================== USER INPUT ==================
read -rp "Masukkan domain (contoh: example.com): " DOMAIN
read -rp "Masukkan email untuk sertifikat (Let's Encrypt): " EMAIL
# Jika ingin otomatis fallback DNS-01 via Cloudflare, export CF_Token sebelumnya:
# export CF_Token="xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
# =================================================

log(){ echo ">> $*"; }

# basic updates & deps
apt update && apt upgrade -y
apt install -y socat cron zip unzip curl wget dnsutils jq sed gnupg2 ca-certificates

# create required folders & logs
mkdir -p /etc/xray /var/log/xray /var/www/html /etc/nginx/conf.d
touch /var/log/xray/access.log /var/log/xray/error.log
chown -R root:root /etc/xray
echo "${DOMAIN}" >/etc/xray/domain

# check DNS records
AAAA=$(dig +short AAAA "${DOMAIN}" | tr -d '\n' || true)
A=$(dig +short A "${DOMAIN}" | tr -d '\n' || true)
log "DNS A: ${A:-<none>}"
log "DNS AAAA: ${AAAA:-<none>}"

if [[ -z "$AAAA" ]]; then
  echo
  log "WARNING: Domain ${DOMAIN} has NO AAAA record. On IPv6-only VPS Let's Encrypt HTTP-01 via IPv6 will likely FAIL."
  echo "Either add AAAA record pointing to your server IPv6, OR prepare CF_Token for DNS-01 fallback (Cloudflare)."
  read -rp "Lanjutkan percobaan issuance kemungkinan gagal? (y/N): " proceed
  if [[ "${proceed,,}" != "y" ]]; then
    log "Abort. Tambahkan AAAA atau siapkan DNS-API lalu jalankan lagi."
    exit 1
  fi
fi

# install acme.sh official
if [[ ! -x "$HOME/.acme.sh/acme.sh" ]]; then
  curl https://get.acme.sh | sh
fi
export PATH="$HOME/.acme.sh:$PATH"
"$HOME/.acme.sh/acme.sh" --upgrade --auto-upgrade || true

# ensure nginx is stopped before standalone issuance
systemctl stop nginx || true
systemctl stop apache2 || true

ACME_SH="$HOME/.acme.sh/acme.sh"
$ACME_SH --help | grep -q -- '--listen-v6' && LISTEN_V6="--listen-v6" || LISTEN_V6=""

ISSUED=0
log "Mencoba issue via acme.sh standalone (IPv6) for ${DOMAIN} ..."
set +e
if $ACME_SH --issue --standalone ${LISTEN_V6} -d "${DOMAIN}" -k ec-256 --accountemail "${EMAIL}"; then
  log "Standalone issuance succeeded."
  $ACME_SH --install-cert -d "${DOMAIN}" \
    --fullchain-file /etc/xray/xray.crt \
    --key-file /etc/xray/xray.key \
    --ecc \
    --reloadcmd "systemctl restart xray || true; systemctl restart nginx || true"
  ISSUED=1
else
  log "Standalone issuance failed. Attempting DNS-01 fallback if CF_Token present."
fi
set -e

# DNS-01 fallback: Cloudflare
if [[ "${ISSUED}" -ne 1 ]]; then
  if [[ -n "${CF_Token:-}" ]]; then
    log "Using Cloudflare DNS API (CF_Token present)."
    export CF_Token
    if $ACME_SH --issue --dns dns_cf -d "${DOMAIN}" -k ec-256 --accountemail "${EMAIL}"; then
      $ACME_SH --install-cert -d "${DOMAIN}" \
        --fullchain-file /etc/xray/xray.crt \
        --key-file /etc/xray/xray.key \
        --ecc \
        --reloadcmd "systemctl restart xray || true; systemctl restart nginx || true"
      ISSUED=1
    else
      log "acme.sh dns_cf issuance failed."
    fi
  else
    log "CF_Token not set; skipping DNS-01 fallback. You may set CF_Token and rerun."
  fi
fi

if [[ "${ISSUED}" -ne 1 ]]; then
  log "Certificate issuance failed. Exiting installer."
  exit 1
fi

log "Certificate installed to /etc/xray/xray.crt and /etc/xray/xray.key"

# Install nginx
apt install -y nginx

# Write nginx xray.conf (cleaned & IPv6-ready). SERVER_NAME substituted.
cat >/etc/nginx/conf.d/xray.conf <<'NGXCONF'
# /etc/nginx/conf.d/xray.conf
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 81;
    listen [::]:81;
    server_name _;
    root /var/www/html;
    access_log /var/log/nginx/xray_port81_access.log;
    error_log  /var/log/nginx/xray_port81_error.log;
}

server {
    listen 80;
    listen [::]:80;
    server_name __SERVER_NAME__;
    root /var/www/html;

    location /.well-known/acme-challenge/ {
        try_files $uri =404;
    }

    location / {
        try_files $uri /index.html =200;
    }

    access_log /var/log/nginx/xray_http_access.log;
    error_log  /var/log/nginx/xray_http_error.log;
}

server {
    listen 443 ssl http2 reuseport;
    listen [::]:443 ssl http2 reuseport;
    server_name __SERVER_NAME__;

    ssl_certificate /etc/xray/xray.crt;
    ssl_certificate_key /etc/xray/xray.key;
    ssl_session_cache shared:TLS:10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:CHACHA20-POLY1305";

    access_log /var/log/nginx/xray_tls_access.log;
    error_log  /var/log/nginx/xray_tls_error.log;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    location /vless {
        proxy_redirect off;
        proxy_pass http://127.0.0.1:10001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
    }

    location / {
        proxy_redirect off;
        proxy_pass http://127.0.0.1:10002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
    }

    location /trojan-ws {
        proxy_redirect off;
        proxy_pass http://127.0.0.1:10003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
    }

    location /ss-ws {
        proxy_redirect off;
        proxy_pass http://127.0.0.1:10004;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
    }

    location /FIGHTERTUNNEL {
        proxy_redirect off;
        proxy_pass http://127.0.0.1:2083;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
    }

    location ^~ /vless-grpc {
        grpc_pass grpc://127.0.0.1:10005;
        grpc_set_header X-Real-IP $remote_addr;
        grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        grpc_set_header Host $http_host;
    }

    location ^~ /vmess-grpc {
        grpc_pass grpc://127.0.0.1:10006;
        grpc_set_header X-Real-IP $remote_addr;
        grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        grpc_set_header Host $http_host;
    }

    location ^~ /trojan-grpc {
        grpc_pass grpc://127.0.0.1:10007;
        grpc_set_header X-Real-IP $remote_addr;
        grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        grpc_set_header Host $http_host;
    }

    location ^~ /ss-grpc {
        grpc_pass grpc://127.0.0.1:10008;
        grpc_set_header X-Real-IP $remote_addr;
        grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        grpc_set_header Host $http_host;
    }
}
NGXCONF

# substitute server_name placeholder
sed -i "s/__SERVER_NAME__/${DOMAIN}/g" /etc/nginx/conf.d/xray.conf

# create basic index.html to camouflage
cat >/var/www/html/index.html <<EOF
<html><head><title>Welcome</title></head><body><h1>Welcome to ${DOMAIN}</h1></body></html>
EOF
chown -R www-data:www-data /var/www/html

# test nginx config & restart
nginx -t
systemctl enable --now nginx
systemctl restart nginx

# Install Xray (official)
log "Installing Xray..."
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install -u www-data --version 1.6.5

# Fetch example config.json (if repo provides one) - optional, best to customize later
if wget -q -O /etc/xray/config.json "https://github.com/axcellsz/gas/raw/main/file/config.json"; then
  log "Downloaded example /etc/xray/config.json (please verify inbound ports match nginx proxy_pass ports)."
else
  log "No sample config downloaded. You must ensure /etc/xray/config.json exists and Xray listens on ports 10001..10004 (ws) and 10005..10008 (grpc) or adjust nginx."
fi

# create systemd unit if not present (keeps original behavior)
cat >/etc/systemd/system/xray.service <<'EOF'
[Unit]
Description=Xray Service
Documentation=https://github.com/xtls
After=network.target nss-lookup.target

[Service]
User=www-data
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=true
ExecStart=/usr/local/bin/xray run -config /etc/xray/config.json
Restart=on-failure
RestartPreventExitStatus=23
LimitNPROC=10000
LimitNOFILE=1000000

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now xray || true
systemctl restart xray || true

log "Selesai. Periksa:"
echo " - nginx config: /etc/nginx/conf.d/xray.conf"
echo " - cert: /etc/xray/xray.crt"
echo " - key:  /etc/xray/xray.key"
echo " - xray config: /etc/xray/config.json (pastikan inbounds sesuai dengan nginx proxy_pass ports)"
echo " - logs: /var/log/nginx/* , /var/log/xray/*"

exit 0
