#!/usr/bin/env bash
set -euo pipefail

# =======================
# EDIT DI SINI
DOMAIN="sgdo1.vhipee.tech"
VLESS_PATH="/vless"
VMESS_PATH="/vmess"
VLESS_PORT="10000"   # nginx -> xray (localhost)
VMESS_PORT="10001"   # nginx -> xray (localhost)
FIRST_USER="admin"   # user pertama (punya nama)
# =======================

export DEBIAN_FRONTEND=noninteractive

need_root() { [[ "${EUID:-$(id -u)}" -eq 0 ]] || { echo "Run as root"; exit 1; }; }
need_root

echo "[0/8] Clean old configs (safe)..."
systemctl stop xray 2>/dev/null || true
systemctl stop nginx 2>/dev/null || true
rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
rm -f /etc/nginx/sites-enabled/xray-ws.conf 2>/dev/null || true
rm -f /etc/nginx/sites-available/xray-ws.conf 2>/dev/null || true

echo "[1/8] Update & install deps..."
apt-get update -y
apt-get install -y curl wget unzip nginx uuid-runtime socat cron jq openssl ca-certificates python3 python3-pip

echo "[2/8] Install Xray (official install script)..."
bash <(curl -fsSL https://github.com/XTLS/Xray-install/raw/main/install-release.sh) install

echo "[3/8] Prepare folders..."
mkdir -p /etc/xray /var/log/xray /var/www/html
touch /var/log/xray/access.log /var/log/xray/error.log
chmod 755 /var/log/xray

echo "$DOMAIN" > /etc/xray/domain

USERS_DB="/etc/xray/users.json"
if [[ ! -f "$USERS_DB" ]]; then
  echo "[]" > "$USERS_DB"
fi

add_user() {
  local name="$1"
  # satu UUID dipakai untuk vless+vmess biar gampang hapus
  local uuid
  uuid="$(cat /proc/sys/kernel/random/uuid)"

  # prevent duplicate name
  if jq -e --arg n "$name" '.[] | select(.name==$n)' "$USERS_DB" >/dev/null; then
    echo "User '$name' sudah ada. Skip."
    return 0
  fi

  jq --arg n "$name" --arg u "$uuid" '. + [{"name":$n,"uuid":$u,"created":(now|todate)}]' \
    "$USERS_DB" > "${USERS_DB}.tmp" && mv "${USERS_DB}.tmp" "$USERS_DB"

  echo "OK: added user $name ($uuid)"
}

del_user() {
  local name="$1"
  jq --arg n "$name" 'map(select(.name != $n))' "$USERS_DB" > "${USERS_DB}.tmp" && mv "${USERS_DB}.tmp" "$USERS_DB"
}

list_users() {
  jq -r '.[] | "\(.name)\t\(.uuid)\t\(.created)"' "$USERS_DB" | column -t || true
}

build_xray_config() {
  local vless_clients vmess_clients
  vless_clients="$(jq -c '[ .[] | {id:.uuid, email:.name, level:0} ]' "$USERS_DB")"
  vmess_clients="$(jq -c '[ .[] | {id:.uuid, alterId:0, email:.name} ]' "$USERS_DB")"

  cat >/usr/local/etc/xray/config.json <<EOF
{
  "log": {
    "loglevel": "warning",
    "access": "/var/log/xray/access.log",
    "error": "/var/log/xray/error.log"
  },
  "inbounds": [
    {
      "tag": "vless-ws",
      "listen": "127.0.0.1",
      "port": ${VLESS_PORT},
      "protocol": "vless",
      "settings": {
        "clients": ${vless_clients},
        "decryption": "none"
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": { "path": "${VLESS_PATH}" }
      },
      "sniffing": { "enabled": true, "destOverride": ["http","tls"] }
    },
    {
      "tag": "vmess-ws",
      "listen": "127.0.0.1",
      "port": ${VMESS_PORT},
      "protocol": "vmess",
      "settings": {
        "clients": ${vmess_clients}
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": { "path": "${VMESS_PATH}" }
      },
      "sniffing": { "enabled": true, "destOverride": ["http","tls"] }
    }
  ],
  "outbounds": [
    { "protocol": "freedom", "tag": "direct" },
    { "protocol": "blackhole", "tag": "block" }
  ]
}
EOF
}

gen_vless_link() {
  local name="$1" uuid="$2"
  echo "vless://${uuid}@${DOMAIN}:443?encryption=none&security=tls&type=ws&host=${DOMAIN}&path=$(python3 - <<PY
import urllib.parse
print(urllib.parse.quote('${VLESS_PATH}'))
PY
)#${name}"
}

gen_vmess_link() {
  local name="$1" uuid="$2"
  python3 - <<PY
import json, base64
cfg={
 "v":"2",
 "ps":"%s"%("${name}"),
 "add":"%s"%("${DOMAIN}"),
 "port":"443",
 "id":"%s"%("${uuid}"),
 "aid":"0",
 "scy":"auto",
 "net":"ws",
 "type":"none",
 "host":"%s"%("${DOMAIN}"),
 "path":"%s"%("${VMESS_PATH}"),
 "tls":"tls"
}
b=base64.b64encode(json.dumps(cfg,separators=(',',':')).encode()).decode()
print("vmess://"+b)
PY
}

echo "[4/8] Create first user: ${FIRST_USER}"
add_user "${FIRST_USER}"

echo "[5/8] Write Xray config (VLESS+VMESS WS behind Nginx TLS)..."
build_xray_config
/usr/local/bin/xray run -test -config /usr/local/etc/xray/config.json >/dev/null

echo "[6/8] Nginx vhost (HTTP for ACME + HTTPS WS proxy)..."
cat >/etc/nginx/sites-available/xray-ws.conf <<EOF
server {
    listen 80;
    listen [::]:80;
    server_name ${DOMAIN};

    root /var/www/html;

    location /.well-known/acme-challenge/ { try_files \$uri =404; }

    location / { return 301 https://\$host\$request_uri; }
}
EOF

ln -sf /etc/nginx/sites-available/xray-ws.conf /etc/nginx/sites-enabled/xray-ws.conf
nginx -t
systemctl enable --now nginx
systemctl restart nginx

echo "[7/8] Install SSL (certbot webroot, non-interactive)..."
apt-get install -y certbot
certbot certonly --webroot -w /var/www/html -d "${DOMAIN}" \
  --agree-tos --register-unsafely-without-email --non-interactive --keep-until-expiring

cat >/etc/nginx/sites-available/xray-ws.conf <<EOF
server {
    listen 80;
    listen [::]:80;
    server_name ${DOMAIN};

    root /var/www/html;

    location /.well-known/acme-challenge/ { try_files \$uri =404; }

    location / { return 301 https://\$host\$request_uri; }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ${DOMAIN};

    ssl_certificate     /etc/letsencrypt/live/${DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${DOMAIN}/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    # VLESS WS
    location ${VLESS_PATH} {
        proxy_redirect off;
        proxy_pass http://127.0.0.1:${VLESS_PORT};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }

    # VMESS WS
    location ${VMESS_PATH} {
        proxy_redirect off;
        proxy_pass http://127.0.0.1:${VMESS_PORT};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }

    # health
    location / {
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
EOF

nginx -t
systemctl restart nginx

echo "[8/8] Start Xray..."
systemctl enable --now xray
systemctl restart xray

# ====== MANAGEMENT SCRIPT ======
cat >/usr/local/bin/xray-menu.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

DOMAIN="$(cat /etc/xray/domain 2>/dev/null || true)"
USERS_DB="/etc/xray/users.json"
CONFIG="/usr/local/etc/xray/config.json"
VLESS_PATH="/vless"
VMESS_PATH="/vmess"
VLESS_PORT="10000"
VMESS_PORT="10001"

need_root(){ [[ "${EUID:-$(id -u)}" -eq 0 ]] || { echo "Run as root"; exit 1; }; }
need_root

add_user() {
  read -rp "Masukkan nama akun: " name
  [[ -n "${name}" ]] || { echo "Nama kosong"; return; }

  if jq -e --arg n "$name" '.[] | select(.name==$n)' "$USERS_DB" >/dev/null; then
    echo "User '$name' sudah ada."
    return
  fi

  uuid="$(cat /proc/sys/kernel/random/uuid)"
  jq --arg n "$name" --arg u "$uuid" '. + [{"name":$n,"uuid":$u,"created":(now|todate)}]' \
    "$USERS_DB" > "${USERS_DB}.tmp" && mv "${USERS_DB}.tmp" "$USERS_DB"

  rebuild_config

  echo
  echo "=== AKUN DIBUAT ==="
  echo "User : $name"
  echo "UUID : $uuid"
  echo
  echo "VLESS:"
  python3 - <<PY
import urllib.parse
print(f"vless://{uuid}@{DOMAIN}:443?encryption=none&security=tls&type=ws&host={DOMAIN}&path={urllib.parse.quote('${VLESS_PATH}') }#{name}")
PY
  echo
  echo "VMESS:"
  python3 - <<PY
import json, base64
cfg={
 "v":"2","ps":"%s","add":"%s","port":"443","id":"%s","aid":"0","scy":"auto",
 "net":"ws","type":"none","host":"%s","path":"%s","tls":"tls"
}
cfg=cfg%("${name}","${DOMAIN}","${uuid}","${DOMAIN}","${VMESS_PATH}")
b=base64.b64encode(json.dumps(cfg,separators=(',',':')).encode()).decode()
print("vmess://"+b)
PY
}

del_user() {
  echo
  echo "=== LIST AKUN ==="
  jq -r '.[] | "\(.name)\t\(.uuid)\t\(.created)"' "$USERS_DB" | column -t || true
  echo
  read -rp "Masukkan nama akun yg mau dihapus: " name
  [[ -n "${name}" ]] || { echo "Nama kosong"; return; }

  jq --arg n "$name" 'map(select(.name != $n))' "$USERS_DB" > "${USERS_DB}.tmp" && mv "${USERS_DB}.tmp" "$USERS_DB"
  rebuild_config
  echo "OK: user '$name' dihapus."
}

list_users() {
  echo
  echo "=== LIST AKUN (Nama / UUID / Created) ==="
  jq -r '.[] | "\(.name)\t\(.uuid)\t\(.created)"' "$USERS_DB" | column -t || true
  echo
  read -rp "Tekan ENTER untuk lanjut..." _
}

rebuild_config() {
  local vless_clients vmess_clients
  vless_clients="$(jq -c '[ .[] | {id:.uuid, email:.name, level:0} ]' "$USERS_DB")"
  vmess_clients="$(jq -c '[ .[] | {id:.uuid, alterId:0, email:.name} ]' "$USERS_DB")"

  cat >"$CONFIG" <<JSON
{
  "log": { "loglevel": "warning", "access": "/var/log/xray/access.log", "error": "/var/log/xray/error.log" },
  "inbounds": [
    {
      "tag": "vless-ws",
      "listen": "127.0.0.1",
      "port": ${VLESS_PORT},
      "protocol": "vless",
      "settings": { "clients": ${vless_clients}, "decryption": "none" },
      "streamSettings": { "network": "ws", "wsSettings": { "path": "${VLESS_PATH}" } },
      "sniffing": { "enabled": true, "destOverride": ["http","tls"] }
    },
    {
      "tag": "vmess-ws",
      "listen": "127.0.0.1",
      "port": ${VMESS_PORT},
      "protocol": "vmess",
      "settings": { "clients": ${vmess_clients} },
      "streamSettings": { "network": "ws", "wsSettings": { "path": "${VMESS_PATH}" } },
      "sniffing": { "enabled": true, "destOverride": ["http","tls"] }
    }
  ],
  "outbounds": [
    { "protocol": "freedom", "tag": "direct" },
    { "protocol": "blackhole", "tag": "block" }
  ]
}
JSON

  /usr/local/bin/xray run -test -config "$CONFIG" >/dev/null
  systemctl restart xray
}

restart_all() {
  systemctl restart xray
  systemctl restart nginx
  echo "OK: Restarted Xray + Nginx"
  read -rp "Tekan ENTER untuk lanjut..." _
}

while true; do
  clear
  echo "=============================="
  echo "          MENU XRAY"
  echo "=============================="
  echo "B. Buat akun (VLESS+VMESS)"
  echo "H. Hapus akun"
  echo "L. List akun"
  echo "R. Restart Xray + Nginx"
  echo "Q. Keluar"
  echo "------------------------------"
  echo "Domain : ${DOMAIN}"
  echo "------------------------------"
  read -rp "Masukan pilihan : " p
  case "${p,,}" in
    b) add_user ;;
    h) del_user ;;
    l) list_users ;;
    r) restart_all ;;
    q) exit 0 ;;
    *) echo "Pilihan salah"; sleep 1 ;;
  esac
done
EOF

chmod +x /usr/local/bin/xray-menu.sh

echo
echo "===== DONE ====="
echo "Domain  : ${DOMAIN}"
echo "Paths   : VLESS=${VLESS_PATH}  VMESS=${VMESS_PATH}"
echo "Ports   : VLESS=${VLESS_PORT}  VMESS=${VMESS_PORT}"
echo
echo "Akun awal:"
list_users || true
echo
echo "Jalankan menu:"
echo "  sudo xray-menu.sh"
echo
echo "Cek service:"
echo "  ss -lntp | egrep ':80|:443|:${VLESS_PORT}|:${VMESS_PORT}'"
echo "  systemctl status xray nginx --no-pager -l"
