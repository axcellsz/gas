#!/usr/bin/env bash
set -euo pipefail

# =======================
# EDIT DI SINI
DOMAIN="sgdo1.vhipee.tech"
VLESS_PATH="/vless"
VMESS_PATH="/vmess"
VLESS_PORT="10000"   # nginx -> xray (localhost)
VMESS_PORT="10001"   # nginx -> xray (localhost)
FIRST_USER="admin"   # user pertama (punya nama)
# =======================

export DEBIAN_FRONTEND=noninteractive

need_root() { [[ "${EUID:-$(id -u)}" -eq 0 ]] || { echo "Run as root"; exit 1; }; }
need_root

XRAY_CONFIG="/usr/local/etc/xray/config.json"
USERS_DB="/etc/xray/users.json"
NGX_SITE="/etc/nginx/sites-available/xray-ws.conf"

echo "[0/9] Stop services & clean nginx sites..."
systemctl stop xray >/dev/null 2>&1 || true
systemctl stop nginx >/dev/null 2>&1 || true

rm -f /etc/nginx/sites-enabled/default >/dev/null 2>&1 || true
rm -f /etc/nginx/sites-enabled/xray-ws.conf >/dev/null 2>&1 || true
rm -f /etc/nginx/sites-available/xray-ws.conf >/dev/null 2>&1 || true

echo "[1/9] Update & install deps..."
apt-get update -y
apt-get install -y curl wget unzip nginx uuid-runtime socat cron jq openssl ca-certificates python3 certbot

echo "[2/9] Install Xray (official script)..."
bash <(curl -fsSL https://github.com/XTLS/Xray-install/raw/main/install-release.sh) install

echo "[3/9] Prepare folders + permissions..."
mkdir -p /etc/xray /var/log/xray /var/www/html /usr/local/etc/xray
touch /var/log/xray/access.log /var/log/xray/error.log
chmod 755 /var/log/xray

# pastikan user xray bisa nulis log
if id xray >/dev/null 2>&1; then
  chown -R xray:xray /var/log/xray
else
  # fallback kalau binary/script bikin user lain
  chown -R root:root /var/log/xray
fi

echo "$DOMAIN" > /etc/xray/domain
echo "$VLESS_PATH" > /etc/xray/vless_path
echo "$VMESS_PATH" > /etc/xray/vmess_path
echo "$VLESS_PORT" > /etc/xray/vless_port
echo "$VMESS_PORT" > /etc/xray/vmess_port

if [[ ! -f "$USERS_DB" ]]; then
  echo "[]" > "$USERS_DB"
fi

add_user_db() {
  local name="$1"
  local uuid
  uuid="$(uuidgen)"

  if jq -e --arg n "$name" '.[] | select(.name==$n)' "$USERS_DB" >/dev/null; then
    echo "User '$name' sudah ada. Skip."
    return 0
  fi

  jq --arg n "$name" --arg u "$uuid" \
    '. + [{"name":$n,"uuid":$u,"created":(now|todateiso8601)}]' \
    "$USERS_DB" > "${USERS_DB}.tmp"
  mv "${USERS_DB}.tmp" "$USERS_DB"
  echo "OK: added user $name ($uuid)"
}

build_xray_config() {
  local vless_clients vmess_clients
  vless_clients="$(jq -c '[ .[] | {id:.uuid, email:.name, level:0} ]' "$USERS_DB")"
  vmess_clients="$(jq -c '[ .[] | {id:.uuid, alterId:0, email:.name} ]' "$USERS_DB")"

  cat >"$XRAY_CONFIG" <<EOF
{
  "log": {
    "loglevel": "warning",
    "access": "/var/log/xray/access.log",
    "error": "/var/log/xray/error.log"
  },
  "inbounds": [
    {
      "tag": "vless-ws",
      "listen": "127.0.0.1",
      "port": ${VLESS_PORT},
      "protocol": "vless",
      "settings": {
        "clients": ${vless_clients},
        "decryption": "none"
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": { "path": "${VLESS_PATH}" }
      },
      "sniffing": { "enabled": true, "destOverride": ["http","tls"] }
    },
    {
      "tag": "vmess-ws",
      "listen": "127.0.0.1",
      "port": ${VMESS_PORT},
      "protocol": "vmess",
      "settings": {
        "clients": ${vmess_clients}
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": { "path": "${VMESS_PATH}" }
      },
      "sniffing": { "enabled": true, "destOverride": ["http","tls"] }
    }
  ],
  "outbounds": [
    { "protocol": "freedom", "tag": "direct" },
    { "protocol": "blackhole", "tag": "block" }
  ]
}
EOF

  chmod 644 "$XRAY_CONFIG"
  /usr/local/bin/xray run -test -config "$XRAY_CONFIG" >/dev/null
}

echo "[4/9] Create first user: ${FIRST_USER}"
add_user_db "${FIRST_USER}"

echo "[5/9] Write Xray config..."
build_xray_config

echo "[6/9] Nginx vhost (HTTP for ACME)..."
cat >"$NGX_SITE" <<EOF
server {
    listen 80;
    listen [::]:80;
    server_name ${DOMAIN};

    root /var/www/html;

    location /.well-known/acme-challenge/ { try_files \$uri =404; }
    location / { return 301 https://\$host\$request_uri; }
}
EOF

ln -sf "$NGX_SITE" /etc/nginx/sites-enabled/xray-ws.conf
nginx -t
systemctl enable --now nginx
systemctl restart nginx

echo "[7/9] SSL (certbot webroot, non-interactive)..."
certbot certonly --webroot -w /var/www/html -d "${DOMAIN}" \
  --agree-tos --register-unsafely-without-email --non-interactive --keep-until-expiring

echo "[8/9] Nginx vhost (HTTPS WS proxy)..."
cat >"$NGX_SITE" <<EOF
server {
    listen 80;
    listen [::]:80;
    server_name ${DOMAIN};

    root /var/www/html;

    location /.well-known/acme-challenge/ { try_files \$uri =404; }
    location / { return 301 https://\$host\$request_uri; }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ${DOMAIN};

    ssl_certificate     /etc/letsencrypt/live/${DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${DOMAIN}/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    # VLESS WS
    location ${VLESS_PATH} {
        proxy_redirect off;
        proxy_pass http://127.0.0.1:${VLESS_PORT};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }

    # VMESS WS
    location ${VMESS_PATH} {
        proxy_redirect off;
        proxy_pass http://127.0.0.1:${VMESS_PORT};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }

    location / {
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
EOF

nginx -t
systemctl restart nginx

echo "[9/9] Start Xray..."
systemctl enable --now xray
systemctl restart xray

# ===== MENU SCRIPT (FIXED) =====
cat >/usr/local/bin/xray-menu.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

DOMAIN="$(cat /etc/xray/domain)"
USERS_DB="/etc/xray/users.json"
CONFIG="/usr/local/etc/xray/config.json"

VLESS_PATH="$(cat /etc/xray/vless_path)"
VMESS_PATH="$(cat /etc/xray/vmess_path)"
VLESS_PORT="$(cat /etc/xray/vless_port)"
VMESS_PORT="$(cat /etc/xray/vmess_port)"

need_root(){ [[ "${EUID:-$(id -u)}" -eq 0 ]] || { echo "Run as root"; exit 1; }; }
need_root

rebuild_config() {
  local vless_clients vmess_clients
  vless_clients="$(jq -c '[ .[] | {id:.uuid, email:.name, level:0} ]' "$USERS_DB")"
  vmess_clients="$(jq -c '[ .[] | {id:.uuid, alterId:0, email:.name} ]' "$USERS_DB")"

  cat >"$CONFIG" <<JSON
{
  "log": { "loglevel": "warning", "access": "/var/log/xray/access.log", "error": "/var/log/xray/error.log" },
  "inbounds": [
    {
      "tag": "vless-ws",
      "listen": "127.0.0.1",
      "port": ${VLESS_PORT},
      "protocol": "vless",
      "settings": { "clients": ${vless_clients}, "decryption": "none" },
      "streamSettings": { "network": "ws", "wsSettings": { "path": "${VLESS_PATH}" } },
      "sniffing": { "enabled": true, "destOverride": ["http","tls"] }
    },
    {
      "tag": "vmess-ws",
      "listen": "127.0.0.1",
      "port": ${VMESS_PORT},
      "protocol": "vmess",
      "settings": { "clients": ${vmess_clients} },
      "streamSettings": { "network": "ws", "wsSettings": { "path": "${VMESS_PATH}" } },
      "sniffing": { "enabled": true, "destOverride": ["http","tls"] }
    }
  ],
  "outbounds": [
    { "protocol": "freedom", "tag": "direct" },
    { "protocol": "blackhole", "tag": "block" }
  ]
}
JSON

  /usr/local/bin/xray run -test -config "$CONFIG" >/dev/null
  systemctl restart xray
}

make_links() {
  local name="$1" uuid="$2"
  local enc_vless enc_vmess
  enc_vless="$(python3 - <<PY
import urllib.parse
print(urllib.parse.quote("${VLESS_PATH}", safe="/"))
PY
)"
  enc_vmess="$(python3 - <<PY
import json, base64
cfg={
 "v":"2",
 "ps":"'"$name"'",
 "add":"'"$DOMAIN"'",
 "port":"443",
 "id":"'"$uuid"'",
 "aid":"0",
 "scy":"auto",
 "net":"ws",
 "type":"none",
 "host":"'"$DOMAIN"'",
 "path":"'"$VMESS_PATH"'",
 "tls":"tls"
}
b=base64.b64encode(json.dumps(cfg,separators=(',',':')).encode()).decode()
print("vmess://"+b)
PY
)"
  echo
  echo "VLESS:"
  echo "vless://${uuid}@${DOMAIN}:443?encryption=none&security=tls&type=ws&host=${DOMAIN}&path=${enc_vless}#${name}"
  echo
  echo "VMESS:"
  echo "${enc_vmess}"
  echo
}

add_user() {
  read -rp "Masukkan nama akun: " name
  [[ -n "${name}" ]] || { echo "Nama kosong"; return; }

  if jq -e --arg n "$name" '.[] | select(.name==$n)' "$USERS_DB" >/dev/null; then
    echo "User '$name' sudah ada."
    sleep 1
    return
  fi

  uuid="$(uuidgen)"
  jq --arg n "$name" --arg u "$uuid" \
    '. + [{"name":$n,"uuid":$u,"created":(now|todateiso8601)}]' \
    "$USERS_DB" > "${USERS_DB}.tmp" && mv "${USERS_DB}.tmp" "$USERS_DB"

  rebuild_config

  echo "=== AKUN DIBUAT ==="
  echo "User : $name"
  echo "UUID : $uuid"
  make_links "$name" "$uuid"
  read -rp "Tekan ENTER untuk lanjut..." _
}

del_user() {
  echo
  echo "=== LIST AKUN ==="
  jq -r '.[] | "\(.name)\t\(.uuid)\t\(.created)"' "$USERS_DB" | column -t || true
  echo
  read -rp "Masukkan NAMA akun yg mau dihapus: " name
  [[ -n "${name}" ]] || { echo "Nama kosong"; return; }

  jq --arg n "$name" 'map(select(.name != $n))' "$USERS_DB" > "${USERS_DB}.tmp" && mv "${USERS_DB}.tmp" "$USERS_DB"
  rebuild_config
  echo "OK: user '$name' dihapus."
  read -rp "Tekan ENTER untuk lanjut..." _
}

list_users() {
  echo
  echo "=== LIST AKUN (Nama / UUID / Created) ==="
  jq -r '.[] | "\(.name)\t\(.uuid)\t\(.created)"' "$USERS_DB" | column -t || true
  echo
  read -rp "Tekan ENTER untuk lanjut..." _
}

restart_all() {
  systemctl restart xray
  systemctl restart nginx
  echo "OK: Restarted Xray + Nginx"
  read -rp "Tekan ENTER untuk lanjut..." _
}

while true; do
  clear
  echo "=============================="
  echo "          MENU XRAY"
  echo "=============================="
  echo "B. Buat akun (VLESS+VMESS)"
  echo "H. Hapus akun"
  echo "L. List akun"
  echo "R. Restart Xray + Nginx"
  echo "Q. Keluar"
  echo "------------------------------"
  echo "Domain : ${DOMAIN}"
  echo "------------------------------"
  read -rp "Masukan pilihan : " p
  case "${p,,}" in
    b) add_user ;;
    h) del_user ;;
    l) list_users ;;
    r) restart_all ;;
    q) exit 0 ;;
    *) echo "Pilihan salah"; sleep 1 ;;
  esac
done
EOF

chmod +x /usr/local/bin/xray-menu.sh

echo
echo "===== DONE ====="
echo "Domain  : ${DOMAIN}"
echo "Paths   : VLESS=${VLESS_PATH}  VMESS=${VMESS_PATH}"
echo "Ports   : VLESS=${VLESS_PORT}  VMESS=${VMESS_PORT}"
echo
echo "Cek listen:"
ss -lntp | egrep ":(80|443|${VLESS_PORT}|${VMESS_PORT})" || true
echo
echo "Menu:"
echo "  sudo /usr/local/bin/xray-menu.sh"
